<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz zum kritischen Denken (Multiplayer)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1E212B;
        }
    </style>
</head>
<body class="bg-[#1E212B] min-h-screen flex items-center justify-center p-4">

    <div id="quiz-container" class="bg-white p-8 rounded-lg shadow-lg w-full max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-[#1E212B] text-center mb-6">Quiz zum kritischen Denken</h1>
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="text-center space-y-4">
            <p class="text-lg text-gray-700">Willkommen zum Multiplayer-Quiz! Werde Host oder trete einem Spiel bei.</p>
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="host-button" class="bg-[#FF8427] text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-[#FFC800] transition-colors">
                    Host
                </button>
                <button id="player-button" class="bg-[#FF8427] text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-[#FFC800] transition-colors">
                    Spieler
                </button>
            </div>
        </div>

        <!-- Host Screen -->
        <div id="host-screen" class="hidden text-center space-y-4">
            <h2 class="text-xl font-bold text-gray-800">Spiel als Host</h2>
            <p id="game-code-display" class="text-2xl font-bold text-[#4D8B31] bg-gray-100 p-4 rounded-md shadow-inner">Code: <span id="game-code">...</span></p>
            <p class="text-lg text-gray-700">Teile diesen Code mit den Spielern.</p>
            <p class="text-md text-gray-500">Warte auf Spieler...</p>
            <div id="host-players-list" class="mt-4 text-left"></div>
            <button id="start-game-button" class="bg-[#FF8427] text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-[#FFC800] transition-colors hidden">
                Spiel starten
            </button>
        </div>

        <!-- Player Screen -->
        <div id="player-screen" class="hidden text-center space-y-4">
            <h2 class="text-xl font-bold text-gray-800">Spiel beitreten</h2>
            <input type="text" id="player-name-input" placeholder="Dein Name" class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#FF8427] transition-colors">
            <input type="text" id="game-code-input" placeholder="Spielcode eingeben" class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#FF8427] transition-colors">
            <button id="join-game-button" class="w-full bg-[#FF8427] text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-[#FFC800] transition-colors">
                Beitreten
            </button>
            <p id="join-status" class="text-md font-semibold mt-2"></p>
        </div>

        <!-- Quiz Area -->
        <div id="quiz-area" class="hidden">
            <div id="question-header" class="mb-4">
                <p id="question-counter" class="text-md text-gray-500 text-center mb-2"></p>
                <div id="players-answered" class="text-sm text-gray-500 text-center mb-2"></div>
            </div>
            <div id="question-area" class="space-y-6">
                <!-- Questions will be injected here -->
            </div>
            <div id="feedback" class="mt-8 text-center text-lg font-semibold"></div>
            <div class="mt-4 text-center">
                 <button id="next-question-button" class="bg-[#FF8427] text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-[#FFC800] transition-colors hidden">
                    Nächste Frage
                </button>
            </div>
        </div>
        
        <!-- Leaderboard -->
        <div id="leaderboard-screen" class="hidden text-center space-y-4">
            <h2 class="text-2xl font-bold mb-4 text-[#1E212B]">Endstand</h2>
            <div id="leaderboard-list" class="text-left mt-4"></div>
            <button id="restart-button" class="bg-[#FF8427] text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-[#FFC800] transition-colors mt-4">
                Neues Spiel starten
            </button>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="hidden text-center space-y-4">
            <p class="text-lg text-gray-700">Lade...</p>
        </div>

        <!-- Modal for error/messages -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                <p id="modal-message" class="text-gray-800 font-semibold mb-4"></p>
                <button id="modal-close" class="bg-[#FF8427] text-white font-semibold py-2 px-4 rounded-md hover:bg-[#FFC800]">OK</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, onSnapshot, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        let gameId = null;
        let isHost = false;
        let gameRef = null;
        let playersRef = null;
        let questionData = [];
        let score = 0;
        let answeredQuestions = new Set();
        let lastAnsweredQuestionIndex = -1;

        const welcomeScreen = document.getElementById('welcome-screen');
        const hostScreen = document.getElementById('host-screen');
        const playerScreen = document.getElementById('player-screen');
        const quizArea = document.getElementById('quiz-area');
        const leaderboardScreen = document.getElementById('leaderboard-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const hostButton = document.getElementById('host-button');
        const playerButton = document.getElementById('player-button');
        const startButton = document.getElementById('start-game-button');
        const joinButton = document.getElementById('join-game-button');
        const playerNameInput = document.getElementById('player-name-input');
        const gameCodeInput = document.getElementById('game-code-input');
        const joinStatus = document.getElementById('join-status');
        const gameCodeDisplay = document.getElementById('game-code');
        const hostPlayersList = document.getElementById('host-players-list');
        const questionArea = document.getElementById('question-area');
        const feedbackElement = document.getElementById('feedback');
        const nextQuestionButton = document.getElementById('next-question-button');
        const playersAnswered = document.getElementById('players-answered');
        const leaderboardList = document.getElementById('leaderboard-list');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalClose = document.getElementById('modal-close');

        async function authenticate() {
            loadingScreen.classList.remove('hidden');
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                showModal(`Authentifizierung fehlgeschlagen: ${error.message}`);
            } finally {
                loadingScreen.classList.add('hidden');
            }
        }

        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        modalClose.addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                welcomeScreen.classList.remove('hidden');
            }
        });

        async function fetchQuizData() {
            return [
                {
                    type: 'text',
                    question: 'Suchen Sie nach der genauen Phrase „Der Bestätigungsfehler ist die Neigung, eine vorgefasste Meinung beizubehalten“. Welche seriöse Quelle finden Sie? (Nutzen Sie den CRAAP-Test)',
                    points: 10,
                    correctAnswer: 'Eine Universität oder wissenschaftliche Einrichtung.',
                    correctAnswerCheck: (userAnswer) => {
                        const keywords = ['uni', 'universität', 'hochschule', 'wissenschaftlich', 'akademisch', 'psychologie', 'markschweizer.ch'];
                        return keywords.some(keyword => userAnswer.toLowerCase().includes(keyword));
                    },
                },
                {
                    type: 'multiple-choice',
                    question: 'Suchen Sie nach dem Begriff „Jaguar Geschwindigkeit“, schließen Sie jedoch Ergebnisse aus, die mit dem Auto zu tun haben. Wie schnell ist ein Jaguar?',
                    points: 10,
                    options: [
                        { text: 'Ein Jaguar kann eine Geschwindigkeit von 20-30 km/h erreichen.', isCorrect: false },
                        { text: 'Ein Jaguar kann eine Geschwindigkeit von 30-50 km/h erreichen.', isCorrect: false },
                        { text: 'Ein Jaguar kann eine Geschwindigkeit von 50-80 km/h erreichen.', isCorrect: true },
                        { text: 'Ein Jaguar kann eine Geschwindigkeit von 80-100 km/h erreichen.', isCorrect: false }
                    ],
                },
                {
                    type: 'multiple-choice',
                    question: 'Was ist der Zweck des CRAAP-Tests?',
                    points: 10,
                    options: [
                        { text: 'Um die Qualität einer wissenschaftlichen Arbeit zu bewerten.', isCorrect: false },
                        { text: 'Um die Glaubwürdigkeit und Verlässlichkeit einer Quelle zu beurteilen.', isCorrect: true },
                        { text: 'Um die Anzahl der Quellen in einem Dokument zu zählen.', isCorrect: false },
                        { text: 'Um die Relevanz einer Quelle für eine bestimmte Frage zu bestimmen.', isCorrect: false }
                    ],
                },
                {
                    type: 'multiple-choice',
                    question: 'Was ist ein Merkmal einer Falschmeldung (Fake News)?',
                    points: 10,
                    options: [
                        { text: 'Eine objektive und sachliche Sprache.', isCorrect: false },
                        { text: 'Die Verwendung von übertriebener, emotional aufgeladener Sprache wie „UNGLAUBLICH!“ oder „OMG!“.', isCorrect: true },
                        { text: 'Eine genaue Angabe der Quellen.', isCorrect: false },
                        { text: 'Eine nüchterne und sachliche Überschrift.', isCorrect: false }
                    ],
                },
                {
                    type: 'multiple-choice',
                    question: 'Nach den Prinzipien des objektiven Recherchierens, was ist ein wichtiger Schritt, um ein ausgewogenes Urteil zu bilden?',
                    points: 10,
                    options: [
                        { text: 'Nur Quellen suchen, die die eigene Meinung bestätigen.', isCorrect: false },
                        { text: 'Fakten recherchieren und bereit sein, neue Informationen zuzulassen.', isCorrect: true },
                        { text: 'Die erste gefundene Information als endgültige Wahrheit akzeptieren.', isCorrect: false },
                        { text: 'Emotionale Appelle als Beweise verwenden.', isCorrect: false }
                    ],
                },
                {
                    type: 'multiple-choice',
                    question: 'Was beschreibt der Bestätigungsfehler?',
                    points: 10,
                    options: [
                        { text: 'Die Neigung, neue Meinungen schnell zu übernehmen, ohne sie zu hinterfragen.', isCorrect: false },
                        { text: 'Die Fähigkeit, objektive Informationen von falschen Informationen zu unterscheiden.', isCorrect: false },
                        { text: 'Die unbewusste Neigung, Informationen zu suchen, zu interpretieren und zu bevorzugen, die die eigenen Überzeugungen bestätigen.', isCorrect: true },
                        { text: 'Das bewusste Ignorieren von Informationen, die den eigenen Ansichten widersprechen.', isCorrect: false }
                    ],
                },
                {
                    type: 'multiple-choice',
                    question: 'Welches CRAAP-Kriterium würde eine Quelle mit übertriebener, emotionaler Sprache am ehesten verletzen?',
                    points: 10,
                    options: [
                        { text: 'Accuracy (Genauigkeit).', isCorrect: false },
                        { text: 'Relevance (Relevanz).', isCorrect: false },
                        { text: 'Purpose (Zweck).', isCorrect: true },
                        { text: 'Currency (Aktualität).', isCorrect: false }
                    ],
                }
            ];
        }

        hostButton.addEventListener('click', async () => {
            isHost = true;
            welcomeScreen.classList.add('hidden');
            loadingScreen.classList.remove('hidden');

            try {
                questionData = await fetchQuizData();
                gameRef = doc(collection(db, `artifacts/${appId}/public/data/games`));
                gameId = gameRef.id;

                await setDoc(gameRef, {
                    hostId: userId,
                    state: 'waiting',
                    currentQuestionIndex: -1,
                    questionCount: questionData.length,
                    createdAt: new Date()
                });

                playersRef = collection(gameRef, 'players');
                await setDoc(doc(playersRef, userId), { name: 'Host', score: 0 });

                gameCodeDisplay.textContent = gameId;
                hostScreen.classList.remove('hidden');

                // Listen for players joining
                onSnapshot(playersRef, (snapshot) => {
                    const players = snapshot.docs.map(d => d.data());
                    hostPlayersList.innerHTML = '';
                    if (players.length > 1) {
                        startButton.classList.remove('hidden');
                    }
                    players.forEach(player => {
                        const playerEl = document.createElement('div');
                        playerEl.textContent = player.name;
                        playerEl.classList.add('p-2', 'bg-gray-100', 'rounded-md', 'mb-2');
                        hostPlayersList.appendChild(playerEl);
                    });
                });
            } catch (error) {
                showModal(`Fehler beim Erstellen des Spiels: ${error.message}`);
                welcomeScreen.classList.remove('hidden');
                hostScreen.classList.add('hidden');
            } finally {
                loadingScreen.classList.add('hidden');
            }
        });

        playerButton.addEventListener('click', () => {
            welcomeScreen.classList.add('hidden');
            playerScreen.classList.remove('hidden');
        });

        joinButton.addEventListener('click', async () => {
            const playerName = playerNameInput.value.trim();
            gameId = gameCodeInput.value.trim();

            if (!playerName || !gameId) {
                showModal('Bitte Name und Spielcode eingeben.');
                return;
            }

            loadingScreen.classList.remove('hidden');

            try {
                gameRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);
                const gameDoc = await getDoc(gameRef);

                if (!gameDoc.exists()) {
                    joinStatus.textContent = 'Spiel nicht gefunden.';
                    joinStatus.classList.add('text-red-500');
                    return;
                }

                playersRef = collection(gameRef, 'players');
                await setDoc(doc(playersRef, userId), { name: playerName, score: 0 });
                joinStatus.textContent = `Beigetreten als ${playerName}. Warte auf den Host...`;
                joinStatus.classList.add('text-green-500');
                playerScreen.classList.add('hidden');
                
                await listenForGameState();
            } catch (error) {
                showModal(`Fehler beim Beitreten: ${error.message}`);
            } finally {
                loadingScreen.classList.add('hidden');
            }
        });

        startButton.addEventListener('click', async () => {
            await updateDoc(gameRef, { state: 'playing', currentQuestionIndex: 0 });
            hostScreen.classList.add('hidden');
            quizArea.classList.remove('hidden');
            nextQuestionButton.classList.remove('hidden');
        });

        async function listenForGameState() {
            questionData = await fetchQuizData();
            onSnapshot(gameRef, (docSnapshot) => {
                const game = docSnapshot.data();
                if (!game) return;

                if (game.state === 'playing') {
                    quizArea.classList.remove('hidden');
                    if (isHost) {
                        hostScreen.classList.add('hidden');
                    } else {
                         playerScreen.classList.add('hidden');
                    }
                    
                    if (game.currentQuestionIndex >= questionData.length) {
                        showLeaderboard();
                        return;
                    }
                    
                    if (game.currentQuestionIndex !== lastAnsweredQuestionIndex) {
                         lastAnsweredQuestionIndex = game.currentQuestionIndex;
                         renderQuestion(game.currentQuestionIndex);
                    }
                    
                    // Listen for players' answers
                    onSnapshot(playersRef, (playerSnapshot) => {
                        const players = playerSnapshot.docs.map(d => d.data());
                        const answered = players.filter(p => p.lastAnswered === game.currentQuestionIndex).length;
                        playersAnswered.textContent = `Antworten: ${answered} von ${players.length}`;
                        if (isHost && answered === players.length) {
                             nextQuestionButton.classList.remove('hidden');
                        } else if (!isHost) {
                             nextQuestionButton.classList.add('hidden');
                        }
                    });

                } else if (game.state === 'finished') {
                    showLeaderboard();
                }
            });
        }
        
        async function renderQuestion(index) {
            const q = questionData[index];
            questionArea.innerHTML = '';
            
            const questionWrapper = document.createElement('div');
            questionWrapper.classList.add('bg-gray-50', 'p-6', 'rounded-lg', 'shadow-sm');

            const questionText = document.createElement('p');
            questionText.classList.add('text-xl', 'font-medium', 'text-gray-700', 'mb-4');
            questionText.textContent = q.question;
            questionWrapper.appendChild(questionText);

            if (q.type === 'multiple-choice') {
                q.options.forEach((option, optionIndex) => {
                    const button = document.createElement('button');
                    button.textContent = option.text;
                    button.classList.add('w-full', 'py-3', 'px-4', 'my-2', 'bg-gray-200', 'rounded-md', 'text-gray-800', 'font-semibold', 'hover:bg-gray-300', 'transition-colors', 'shadow-sm', 'text-left');
                    button.onclick = () => handleAnswer(index, optionIndex, option.isCorrect);
                    questionWrapper.appendChild(button);
                });
            } else if (q.type === 'text') {
                 const input = document.createElement('input');
                 input.type = 'text';
                 input.placeholder = q.placeholder;
                 input.classList.add('w-full', 'py-3', 'px-4', 'my-2', 'bg-gray-100', 'rounded-md', 'border', 'border-gray-300', 'focus:outline-none', 'focus:ring-2', 'focus:ring-[#FF8427]');
                 questionWrapper.appendChild(input);

                 const submitButton = document.createElement('button');
                 submitButton.textContent = 'Antwort abschicken';
                 submitButton.classList.add('w-full', 'py-3', 'px-6', 'mt-4', 'bg-[#FF8427]', 'text-white', 'font-semibold', 'rounded-md', 'shadow-md', 'hover:bg-[#FFC800]', 'transition-colors');
                 submitButton.onclick = () => {
                     const userAnswer = input.value.trim();
                     if (answeredQuestions.has(index)) return;
                     const isCorrect = q.correctAnswerCheck(userAnswer);
                     handleAnswer(index, userAnswer, isCorrect);
                 };
                 questionWrapper.appendChild(submitButton);
            }
            
            questionArea.appendChild(questionWrapper);
            document.getElementById('question-counter').textContent = `Frage ${index + 1} von ${questionData.length}`;
            feedbackElement.textContent = '';
            playersAnswered.textContent = 'Antworten: 0 von ...';
            if (!isHost) {
                nextQuestionButton.classList.add('hidden');
            }
        }

        async function handleAnswer(questionIndex, userAnswer, isCorrect) {
            if (answeredQuestions.has(questionIndex)) return;
            answeredQuestions.add(questionIndex);
            
            let pointsEarned = 0;
            if (isCorrect) {
                pointsEarned = questionData[questionIndex].points;
                feedbackElement.textContent = 'Richtig!';
                feedbackElement.classList.add('text-green-600');
            } else {
                feedbackElement.textContent = 'Falsch.';
                feedbackElement.classList.add('text-red-500');
            }

            try {
                const playerRef = doc(playersRef, userId);
                await updateDoc(playerRef, {
                    score: score + pointsEarned,
                    lastAnswered: questionIndex,
                    lastAnswer: userAnswer,
                    isCorrect: isCorrect
                });
                score += pointsEarned;
            } catch (error) {
                showModal(`Fehler beim Speichern der Antwort: ${error.message}`);
            }

            disableAllOptions();
        }

        function disableAllOptions() {
            const options = questionArea.querySelectorAll('button, input');
            options.forEach(option => {
                option.disabled = true;
            });
        }
        
        nextQuestionButton.addEventListener('click', async () => {
            const gameDoc = await getDoc(gameRef);
            const game = gameDoc.data();
            const nextIndex = game.currentQuestionIndex + 1;
            if (nextIndex < questionData.length) {
                await updateDoc(gameRef, { currentQuestionIndex: nextIndex });
                nextQuestionButton.classList.add('hidden');
            } else {
                await updateDoc(gameRef, { state: 'finished' });
            }
        });

        async function showLeaderboard() {
            quizArea.classList.add('hidden');
            loadingScreen.classList.remove('hidden');

            try {
                const q = query(collection(gameRef, 'players'));
                const querySnapshot = await getDocs(q);
                
                let players = [];
                querySnapshot.forEach(doc => {
                    if(doc.id !== userId && doc.data().name !== 'Host') {
                        players.push({ id: doc.id, ...doc.data() });
                    }
                });
                
                // Sort players by score
                players.sort((a, b) => b.score - a.score);

                leaderboardList.innerHTML = '';
                players.forEach((player, index) => {
                    const playerEl = document.createElement('div');
                    playerEl.classList.add('flex', 'justify-between', 'items-center', 'p-4', 'bg-gray-100', 'rounded-md', 'mb-2', 'shadow-sm');
                    if (index === 0) {
                        playerEl.classList.add('bg-[#FFC800]', 'font-bold');
                    }
                    playerEl.innerHTML = `
                        <span class="text-lg">${index + 1}. ${player.name}</span>
                        <span class="text-lg">${player.score} Punkte</span>
                    `;
                    leaderboardList.appendChild(playerEl);
                });

                leaderboardScreen.classList.remove('hidden');
            } catch (error) {
                showModal(`Fehler beim Laden des Leaderboards: ${error.message}`);
            } finally {
                loadingScreen.classList.add('hidden');
            }
        }

        authenticate();
    </script>
</body>
</html>
